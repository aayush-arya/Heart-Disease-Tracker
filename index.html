<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Disease Tracker - Predictive Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            transition: all 0.3s ease-in-out;
        }

        .dynamic-input {
            border: 2px solid #4b5563;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .dynamic-input:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
        }
        .predict-button {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            box-shadow: 0 5px 0 0 #b91c1c;
        }
        .predict-button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 0 #b91c1c;
        }
        /* Style for the canvas container to maintain aspect ratio and alignment */
        #ecg-container {
            width: 100%;
            height: 120px; /* Fixed height for the canvas */
            background-color: #0b0f14;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 24px;
        }
        #ecgCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-gray-900/95 backdrop-blur-sm p-6 sm:p-12 rounded-3xl shadow-[0_20px_50px_rgba(200,0,0,0.3)] border border-red-800/50">
        
        <header class="text-center mb-10 pb-6 border-b border-red-900/50">
            <h1 class="text-5xl font-black text-red-500 mb-2 tracking-wider uppercase">
                Heart Disease Tracker
            </h1>
        </header>

        <!-- Dynamic ECG Visualization Area -->
        <div id="ecg-container">
            <canvas id="ecgCanvas"></canvas>
        </div>

        <form id="predictionForm" class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">

            <!-- 1. Clinical & Demographics -->
            <div class="md:col-span-3">
                <h2 class="text-2xl font-bold mb-4 text-red-400 border-b border-gray-700 pb-1">Patient Vitals & History</h2>
            </div>
            
            <!-- 1. age -->
            <div>
                <label for="age" class="block text-sm font-medium text-gray-300">1. Age (years):</label>
                <span class="text-xs text-gray-400 font-light italic">Patient's age</span>
                <input type="number" id="age" value="55" required min="29" max="77" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 2. sex -->
            <div>
                <label for="sex" class="block text-sm font-medium text-gray-300">2. Sex (1=Male, 0=Female):</label>
                <span class="text-xs text-gray-400 font-light italic">Biological sex</span>
                <input type="number" id="sex" value="1" required min="0" max="1" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 3. cp (Chest Pain Type) -->
            <div>
                <label for="cp" class="block text-sm font-medium text-gray-300">3. Chest Pain Type (1-4):</label>
                <span class="text-xs text-gray-400 font-light italic">Angina classification</span>
                <input type="number" id="cp" value="3" required min="1" max="4" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 4. trestbps (Resting Blood Pressure) -->
            <div>
                <label for="trestbps" class="block text-sm font-medium text-gray-300">4. Resting BP (mm Hg):</label>
                <span class="text-xs text-gray-400 font-light italic">At rest</span>
                <input type="number" id="trestbps" value="130" required min="90" max="200" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>
            
            <!-- 5. chol (Serum Cholestoral) -->
            <div>
                <label for="chol" class="block text-sm font-medium text-gray-300">5. Cholesterol (mg/dL):</label>
                <span class="text-xs text-gray-400 font-light italic">Serum lab result</span>
                <input type="number" id="chol" value="240" required min="120" max="560" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 6. fbs (Fasting Blood Sugar) -->
            <div>
                <label for="fbs" class="block text-sm font-medium text-gray-300">6. Fasting Sugar > 120 (1/0):</label>
                <span class="text-xs text-gray-400 font-light italic">High sugar indicator</span>
                <input type="number" id="fbs" value="0" required min="0" max="1" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>
            
            <!-- 7. restecg (Resting ECG) -->
            <div>
                <label for="restecg" class="block text-sm font-medium text-gray-300">7. Resting ECG (0-2):</label>
                <span class="text-xs text-gray-400 font-light italic">Electrocardiogram result</span>
                <input type="number" id="restecg" value="1" required min="0" max="2" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 8. thalach (Max Heart Rate) -->
            <div>
                <label for="thalach" class="block text-sm font-medium text-gray-300">8. Max Heart Rate (bpm):</label>
                <span class="text-xs text-gray-400 font-light italic">Achieved during exercise</span>
                <input type="number" id="thalach" value="150" required min="70" max="210" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 9. exang (Exercise Induced Angina) -->
            <div>
                <label for="exang" class="block text-sm font-medium text-gray-300">9. Exercise Angina (1=Yes, 0=No):</label>
                <span class="text-xs text-gray-400 font-light italic">Pain during exertion</span>
                <input type="number" id="exang" value="0" required min="0" max="1" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 10. oldpeak (ST depression) -->
            <div>
                <label for="oldpeak" class="block text-sm font-medium text-gray-300">10. ST Depression (0.0 - 6.2):</label>
                <span class="text-xs text-gray-400 font-light italic">ECG segment change</span>
                <input type="number" id="oldpeak" value="1.5" required min="0" max="7" step="0.1" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 11. slope (Peak Exercise ST Segment) -->
            <div>
                <label for="slope" class="block text-sm font-medium text-gray-300">11. Peak ST Slope (1-3):</label>
                <span class="text-xs text-gray-400 font-light italic">Slope during exercise</span>
                <input type="number" id="slope" value="2" required min="1" max="3" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 12. ca (Number of major vessels) -->
            <div>
                <label for="ca" class="block text-sm font-medium text-gray-300">12. Num Major Vessels (0-3):</label>
                <span class="text-xs text-gray-400 font-light italic">Vessels seen by fluoroscopy</span>
                <input type="number" id="ca" value="0" required min="0" max="3" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- 13. thal (Thalassaemia) -->
            <div>
                <label for="thal" class="block text-sm font-medium text-gray-300">13. Thal (3=Normal, 7=Reversable):</label>
                <span class="text-xs text-gray-400 font-light italic">Blood disorder status</span>
                <input type="number" id="thal" value="3" required min="3" max="7" class="dynamic-input mt-1 block w-full bg-gray-800 border-gray-600 rounded-lg focus:border-red-500 p-3 text-lg">
            </div>

            <!-- Spacer column to align button -->
            <div class="hidden md:block"></div> 
            <div class="hidden md:block"></div> 

            <!-- Prediction Button -->
            <div class="md:col-span-3 pt-8">
                <button type="submit" id="predictButton" class="predict-button w-full py-4 px-4 rounded-xl text-xl font-extrabold text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
                    ANALYZE HEART RISK
                </button>
            </div>

            <!-- Result Display Area -->
            <div class="md:col-span-3 mt-8">
                <div id="resultArea" class="hidden bg-gray-800/80 p-6 rounded-xl border-l-8 border-transparent shadow-2xl">
                    <h3 class="text-3xl font-bold mb-4 text-white">Assessment Result</h3>
                    <p id="resultText" class="text-2xl font-black mb-2"></p>
                    <div id="resultDetails" class="text-gray-300 text-base"></div>
                    <p id="errorFeedback" class="text-sm bg-red-900/50 p-2 rounded mt-4 hidden"></p>
                </div>
            </div>
        </form>
    </div>

    <!-- START OF JAVASCRIPT LOGIC -->
    <script>
        // --- 1. ECG Animation Logic ---
        const canvas = document.getElementById('ecgCanvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        let beatPhase = 0; // Tracks the position in the ECG waveform

        // Function to resize canvas to fit container
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        // Draws a single QRS complex (the main spike) based on the phase
        function getECGY(x, width, height) {
            const phase = (x / width) * 2 * Math.PI * 2; // Two full cycles visible
            const center = height / 2;
            const amplitude = height * 0.4;
            
            // Simple sine wave for the baseline
            let y = center + Math.sin(phase) * amplitude * 0.1; 

            // Simulate the R peak near the start of the visible waveform (e.g., around x=100)
            const spikePosition = (beatPhase % 1.0) * width;
            const distance = Math.abs(x - spikePosition);
            const spikeWidth = 20;

            if (distance < spikeWidth) {
                // Creates a sharp V-shape for the QRS complex
                y = center - (amplitude * 0.8) * (1 - (distance / spikeWidth));
            }

            return y;
        }

        function drawECG() {
            if (!ctx) return;
            resizeCanvas(); // Ensure resizing happens before drawing

            const width = canvas.width;
            const height = canvas.height;
            const lineHeight = height * 0.5; // Baseline center

            ctx.clearRect(0, 0, width, height);
            
            // Draw grid (optional, for realism)
            ctx.strokeStyle = '#223344';
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            for (let i = 0; i < width; i += 20) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i, height);
            }
            for (let i = 0; i < height; i += 20) {
                ctx.moveTo(0, i);
                ctx.lineTo(width, i);
            }
            ctx.stroke();

            // Draw the ECG line
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444'; // Red line
            ctx.lineWidth = 2;
            
            // Move the line based on the animation phase
            for (let x = 0; x <= width; x++) {
                // Use the animation phase to shift the input for the wave function
                const phaseShift = beatPhase * 100; // Speed of scroll
                const y = getECGY(x + phaseShift, width, height);
                
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            beatPhase += 0.015; // Animation speed
            if (beatPhase > 1) beatPhase = 0;

            animationFrameId = requestAnimationFrame(drawECG);
        }

        // Start the animation loop when the window loads
        window.onload = function() {
            resizeCanvas();
            drawECG();
            window.addEventListener('resize', resizeCanvas);
        }

        // --- 2. Prediction Logic (Unchanged but included for completeness) ---
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const button = document.getElementById('predictButton');
            const resultArea = document.getElementById('resultArea');
            const resultText = document.getElementById('resultText');
            const resultDetails = document.getElementById('resultDetails');
            const errorFeedback = document.getElementById('errorFeedback');
            
            button.disabled = true;
            button.textContent = 'Analyzing...';
            resultArea.classList.add('hidden');
            errorFeedback.classList.add('hidden');

            const featureIds = [
                'age', 'sex', 'cp', 'trestbps', 'chol', 'fbs', 'restecg', 
                'thalach', 'exang', 'oldpeak', 'slope', 'ca', 'thal'
            ];
            
            const features = featureIds.map(id => parseFloat(document.getElementById(id).value));

            const API_URL = '/predict'; 

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ features: features }),
                });

                if (!response.ok) { throw new Error(`API returned status ${response.status}`); }

                const data = await response.json();

                if (data.error) { throw new Error(`API Error: ${data.error}`); }
                
                const isRisk = data.prediction === 1;
                
                if (isRisk) {
                    resultText.textContent = 'WARNING: HIGH RISK OF HEART DISEASE';
                    resultText.className = 'text-3xl font-black text-red-400 mb-2';
                    resultArea.style.borderColor = '#f87171';
                } else {
                    resultText.textContent = 'LOW RISK OF HEART DISEASE';
                    resultText.className = 'text-3xl font-black text-green-400 mb-2';
                    resultArea.style.borderColor = '#4ade80';
                }

                resultDetails.innerHTML = `
                    <p class="mt-2 text-lg">Disease Probability: <span class="font-extrabold ${isRisk ? 'text-red-300' : 'text-green-300'}">${(data.probability_disease * 100).toFixed(2)}%</span></p>
                    <p>No Disease Probability: <span class="font-extrabold text-gray-300">${(data.probability_no_disease * 100).toFixed(2)}%</span></p>
                    <p class="text-xs mt-3 text-red-200/50">Model: ${data.model_used}</p>
                `;

                resultArea.classList.remove('hidden');

            } catch (error) {
                console.error("Prediction failed:", error);
                errorFeedback.textContent = `CRITICAL ERROR: Could not process prediction. Check server logs. Details: (${error.message})`;
                errorFeedback.classList.remove('hidden');
                resultArea.classList.remove('hidden');
                resultText.textContent = 'ANALYSIS FAILED';
                resultText.className = 'text-3xl font-black text-red-400 mb-2';
                resultArea.style.borderColor = '#991b1b';
                resultDetails.innerHTML = '';
            } finally {
                button.disabled = false;
                button.textContent = 'ANALYZE HEART RISK';
            }
        });
    </script>
</body>
</html>
